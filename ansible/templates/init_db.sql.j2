-- PostgreSQL Database Initialization Script
-- Generated by Ansible

-- Create user if not exists
DO
$$
BEGIN
   IF NOT EXISTS (
      SELECT FROM pg_catalog.pg_roles
      WHERE rolname = '{{ app_db_user }}'
   ) THEN
      CREATE USER {{ app_db_user }} WITH
        ENCRYPTED PASSWORD '{{ app_db_password }}'
        NOCREATEDB
        NOSUPERUSER;
      RAISE NOTICE 'User {{ app_db_user }} created successfully';
   ELSE
      RAISE NOTICE 'User {{ app_db_user }} already exists, skipping creation';
   END IF;
END
$$;

-- Create database if it doesn't exist
SELECT 'CREATE DATABASE {{ pg_db_name }}'
WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ pg_db_name }}')
\gexec

-- Set ownership and grant privileges
ALTER DATABASE {{ pg_db_name }} OWNER TO {{ app_db_user }};
GRANT ALL PRIVILEGES ON DATABASE {{ pg_db_name }} TO {{ app_db_user }};

-- Output confirmation message
\echo 'PostgreSQL initialization completed successfully'
\echo 'User: {{ app_db_user }}'
\echo 'Database: {{ pg_db_name }}'

