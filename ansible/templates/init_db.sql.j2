-- PostgreSQL Database Initialization Script
-- Generated by Ansible

-- Create user if not exists
DO
$$
BEGIN
   IF NOT EXISTS (
      SELECT FROM pg_catalog.pg_roles
      WHERE rolname = '{{ pg_db_user }}'
   ) THEN
      CREATE USER {{ pg_db_user }} WITH
        ENCRYPTED PASSWORD '{{ pg_db_password }}'
        NOCREATEDB
        NOSUPERUSER;
      RAISE NOTICE 'User {{ pg_db_user }} created successfully';
ELSE
      RAISE NOTICE 'User {{ pg_db_user }} already exists, skipping creation';
END IF;
END
$$;

-- Create database if not exists
DO
$$
BEGIN
   IF NOT EXISTS (
      SELECT FROM pg_database
      WHERE datname = '{{ pg_db_name }}'
   ) THEN
      CREATE DATABASE {{ pg_db_name }}
        WITH
        OWNER = {{ pg_db_user }}
        ENCODING = '{{ pg_encoding }}'
        LC_COLLATE = '{{ pg_locale }}'
        LC_CTYPE = '{{ pg_locale }}'
        TEMPLATE = template0
        CONNECTION LIMIT = -1;
      RAISE NOTICE 'Database {{ pg_db_name }} created successfully';
ELSE
      RAISE NOTICE 'Database {{ pg_db_name }} already exists, skipping creation';
END IF;
END
$$;

-- Grant privileges to user on database
GRANT ALL PRIVILEGES ON DATABASE {{ pg_db_name }} TO {{ pg_db_user }};

-- Output confirmation message
\echo 'PostgreSQL initialization completed successfully'
\echo 'User: {{ pg_db_user }}'
\echo 'Database: {{ pg_db_name }}'